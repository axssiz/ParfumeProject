<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Worker</title>
    <link rel="stylesheet" href="/static/style/worker.css" />
  </head>
  <style>
    /* --- Глобальные настройки и фон --- */
    body {
      font-family: "Roboto", sans-serif;
      background-color: #f8f6f6;
      color: #333;
      margin: 0;
      padding: 30px;
    }

    /* --- Заголовки и Навигация --- */
    h1 {
      color: #5e191e;
      font-size: 32px;
      font-weight: 500;
      margin-bottom: 5px;
    }

    h2 {
      color: #5e191e;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 8px;
      margin-top: 40px;
      margin-bottom: 20px;
      font-size: 24px;
      font-weight: 400;
    }

    a {
      display: inline-block;
      margin-bottom: 20px;
      padding: 8px 15px;
      background-color: #a0a0a0; /* Серый */
      color: white;
      text-decoration: none;
      border-radius: 6px;
      transition: background-color 0.3s;
    }

    a:hover {
      background-color: #7d7d7d;
    }

    /* --- Стилизация Формы Добавления --- */
    form[action="/worker/add_perfume"] {
      background-color: #ffffff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      max-width: 500px;
    }

    form[action="/worker/add_perfume"] > * {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box; /* Важно для padding */
      font-size: 15px;
      transition: border-color 0.3s;
    }

    form[action="/worker/add_perfume"] input:focus,
    form[action="/worker/add_perfume"] textarea:focus,
    form[action="/worker/add_perfume"] select:focus {
      border-color: #5e191e; /* Цвет бренда при фокусировке */
      outline: none;
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* Кнопка "Добавить" */
    form[action="/worker/add_perfume"] button[type="submit"] {
      background-color: #5e191e;
      color: white;
      font-weight: 500;
      cursor: pointer;
      border: none;
      padding: 12px;
      border-radius: 6px;
      transition: background-color 0.3s;
    }

    form[action="/worker/add_perfume"] button[type="submit"]:hover {
      background-color: #401014; /* Более темный оттенок */
    }

    /* --- Стилизация Таблицы --- */
    .table-container {
      overflow-x: auto;
      border-radius: 12px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background-color: #ffffff;
      min-width: 600px;
    }

    th,
    td {
      padding: 14px 18px;
      text-align: left;
      border-bottom: 1px solid #e8e8e8;
      font-size: 14px;
    }

    th {
      background-color: #5e191e; /* Цвет бренда для заголовков */
      color: white;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    tr:nth-child(even) {
      background-color: #fcfcfc;
    }
    tr:hover {
      background-color: #f7e8e8; /* Светлый ховер-эффект */
    }

    tr:last-child td {
      border-bottom: none;
    }

    /* Кнопки действий в таблице */
    td button {
      background-color: #e53935; /* Красный для "Удалить" */
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s;
      font-weight: 500;
    }

    td button:hover {
      background-color: #c62828;
    }

    /* Отзывчивость */
    @media (max-width: 600px) {
      body {
        padding: 15px;
      }
      form[action="/worker/add_perfume"] {
        padding: 20px;
      }
    }

    /* Orders area */
    #orders-area {
      margin-top: 18px;
    }
    #orders-list {
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .order-card {
      background: #fff;
      padding: 12px 14px;
      border-radius: 10px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .order-card .left {
      display: flex;
      flex-direction: column;
    }
    .order-card .title {
      font-weight: 600;
      color: #222;
    }
    .order-card .meta {
      font-size: 13px;
      color: #666;
      margin-top: 4px;
    }
    .order-card .actions {
      display: flex;
      gap: 8px;
    }
    .order-card button {
      background: #5e191e;
      color: #fff;
      border-radius: 8px;
      padding: 8px 10px;
      border: none;
      cursor: pointer;
    }
    .order-card button.ack {
      background: #2e8b57;
    }

    /* Order details modal */
    .order-detail-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1300;
    }
    .order-detail-box {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      max-width: 480px;
      width: 94%;
      box-shadow: 0 24px 48px rgba(0, 0, 0, 0.12);
    }
    .order-detail-box h3 {
      margin: 0 0 8px;
      color: #5e191e;
    }
    .order-detail-box .row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px dashed #eee;
    }
    .order-detail-box .row:last-child {
      border-bottom: none;
    }
    .order-detail-box .label {
      color: #666;
    }
    .order-detail-box .value {
      font-weight: 600;
      color: #222;
    }
    .order-detail-box .close {
      margin-top: 12px;
      background: #f0f0f0;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
    }

    @media (max-width: 480px) {
      .order-detail-box {
        padding: 14px;
      }
    }
  </style>
  <body>
    <h1>Worker panel</h1>
    <a href="/profile">Back to profile</a>

    <h2>Add perfume</h2>
    <form action="/worker/add_perfume" method="post">
      <input name="name" placeholder="Name" required /><br />
      <input name="brand" placeholder="Brand" /><br />
      <input name="price" type="number" step="0.01" placeholder="Price" /><br />
      <input name="volume_ml" type="number" placeholder="Ml" /><br />
      <input name="image_url" placeholder="Image URL" /><br />
      <textarea name="description" placeholder="Description"></textarea><br />
      <select name="gender">
        <option value="">—</option>
        <option value="male">male</option>
        <option value="female">female</option>
        <option value="unisex">unisex</option></select
      ><br />
      <button type="submit">Add</button>
    </form>

    <h2>List</h2>
    <table>
      <tr>
        <th>id</th>
        <th>name</th>
        <th>brand</th>
        <th>price</th>
        <th>actions</th>
      </tr>
      {% for p in parfumes %}
      <tr>
        <td>{{ p[0] }}</td>
        <td>{{ p[1] }}</td>
        <td>{{ p[2] }}</td>
        <td>{{ p[3] }}</td>
        <td>
          <!-- Для редактирования можно сделать отдельную форму или страницу -->
          <form
            action="/worker/delete_perfume/{{ p[0] }}"
            method="post"
            style="display: inline-block"
          >
            <button type="submit">Delete</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </table>

    <h2>New orders</h2>
    <div id="orders-area">
      <p id="orders-empty">There are no new orders yet.</p>
      <ul id="orders-list" style="list-style: none; padding: 0"></ul>
    </div>

    <script>
      (function () {
        const listEl = document.getElementById("orders-list");
        const emptyEl = document.getElementById("orders-empty");
        let seen = new Set();

        function renderOrders(orders) {
          listEl.innerHTML = "";
          if (!orders || orders.length === 0) {
            emptyEl.style.display = "";
            return;
          }
          emptyEl.style.display = "none";
          orders.forEach((o) => {
            const li = document.createElement("li");
            li.className = "order-card";
            // build title from items if available
            const title =
              o.items && o.items.length > 0
                ? o.items
                    .map((i) => i.name)
                    .slice(0, 2)
                    .join(", ")
                : (o.perfume && (o.perfume.name || o.perfume.title)) || "—";
            const metaPrice = o.total_price
              ? o.total_price
              : o.perfume && o.perfume.price
              ? o.perfume.price
              : "";
            li.innerHTML = `<div class="left"><div class="title">${title}</div><div class="meta">${
              (o.items && o.items[0] && o.items[0].brand) ||
              (o.perfume && o.perfume.brand) ||
              ""
            } • ${metaPrice} — <small>№${o.order_num || o.id} — ${
              o.status
            }</small></div></div><div class="actions"></div>`;
            const actions = li.querySelector(".actions");
            const viewBtn = document.createElement("button");
            viewBtn.textContent = "Детали";
            viewBtn.onclick = (ev) => {
              ev.stopPropagation();
              showOrderDetail(o);
            };
            const ackBtn = document.createElement("button");
            ackBtn.className = "ack";
            ackBtn.textContent = "Mark processed";
            ackBtn.onclick = async (ev) => {
              ev.stopPropagation();
              await fetch("/api/orders/" + o.id + "/status", {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ status: "in_progress" }),
              });
              li.remove();
            };
            actions.appendChild(viewBtn);
            actions.appendChild(ackBtn);
            listEl.appendChild(li);
            li.onclick = () => showOrderDetail(o);

            if (
              !seen.has(o.id) &&
              (o.status === "pending" || o.status === "new")
            ) {
              seen.add(o.id);
              try {
                new Notification("New order", {
                  body: o.perfume.name || "New product",
                });
              } catch (e) {}
            }
          });
        }

        function showOrderDetail(o) {
          const modal = document.createElement("div");
          modal.className = "order-detail-modal";
          const box = document.createElement("div");
          box.className = "order-detail-box";
          const name = o.customer_name || "—";
          const phone = o.customer_phone || "—";
          const email = o.customer_email || "—";
          const city = o.customer_city || "—";
          const comment = o.customer_comment || "(there is no comment)";
          // build items HTML
          let itemsHtml = "";
          if (o.items && o.items.length > 0) {
            itemsHtml =
              '<div class="row"><div class="label">Items</div><div class="value">' +
              o.items
                .map((it) => `${it.name} × ${it.quantity} — ${it.price} ₸`)
                .join("<br/>") +
              "</div></div>";
          } else if (o.perfume) {
            itemsHtml =
              '<div class="row"><div class="label">Item</div><div class="value">' +
              (o.perfume.name || o.perfume.title || "—") +
              "</div></div>";
          }
          box.innerHTML = `
            <h3>Заказ №${o.order_num || o.id}</h3>
            ${itemsHtml}
            <div class="row"><div class="label">Total</div><div class="value">${
              o.total_price
                ? o.total_price + " ₸"
                : o.perfume && o.perfume.price
                ? o.perfume.price + " ₸"
                : "—"
            }</div></div>
            <div class="row"><div class="label">Client's name</div><div class="value">${name}</div></div>
            <div class="row"><div class="label">Number</div><div class="value">${phone}</div></div>
            <div class="row"><div class="label">Email</div><div class="value">${email}</div></div>
            <div class="row"><div class="label">City</div><div class="value">${city}</div></div>
            <div class="row"><div class="label">Comment</div><div class="value">${comment}</div></div>
            <div class="row"><div class="label">Status</div><div class="value" style="font-weight:bold;color:#5e191e">${
              o.status
            }</div></div>
              <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px" id="order-actions-area"></div>
              <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px"><button class="close" style="background:#f0f0f0;padding:8px 10px;border-radius:8px;border:none;cursor:pointer">Close</button></div>
          `;
          modal.appendChild(box);
          document.body.appendChild(modal);
          box.querySelector(".close").onclick = () => modal.remove();

          // actions area: request confirmation, confirm, processing, sent, delivered, cancel
          const actionsArea = box.querySelector("#order-actions-area");
          function makeBtn(text, color, id) {
            const b = document.createElement("button");
            b.id = id;
            b.textContent = text;
            b.style.background = color;
            b.style.color = "#fff";
            b.style.padding = "8px 10px";
            b.style.border = "none";
            b.style.borderRadius = "8px";
            b.style.cursor = "pointer";
            b.style.fontSize = "12px";
            return b;
          }
          // create buttons with appropriate labels and colors
          const btnRequest = makeBtn(
            "Request confirmation",
            "orange",
            "btn-request"
          );
          const btnProcess = makeBtn("In processing", "#5e191e", "btn-process");
          const btnSend = makeBtn("Sent", "blue", "btn-send");
          const btnDeliver = makeBtn("Delivered", "green", "btn-deliver");
          const btnCancel = makeBtn("Сancel", "red", "btn-cancel");

          // add all buttons
          actionsArea.appendChild(btnRequest);
          actionsArea.appendChild(btnProcess);
          actionsArea.appendChild(btnSend);
          actionsArea.appendChild(btnDeliver);
          actionsArea.appendChild(btnCancel);

          async function setStatus(s) {
            try {
              await fetch("/api/orders/" + o.id + "/status", {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ status: s }),
              });
              modal.remove();
              poll();
            } catch (e) {
              console.error(e);
              alert("Error when changing the status");
            }
          }
          btnRequest.onclick = () => setStatus("confirmed");
          btnProcess.onclick = () => setStatus("in_progress");
          btnSend.onclick = () => setStatus("shipped");
          btnDeliver.onclick = () => setStatus("delivered");
          btnCancel.onclick = () => setStatus("cancelled");
        }

        async function poll() {
          try {
            const r = await fetch("/api/orders", { credentials: "include" });
            const j = await r.json();
            renderOrders(j.orders || []);
          } catch (e) {
            console.error("orders poll error", e);
          }
        }

        // попросим разрешение на показ Notification
        if (window.Notification && Notification.permission !== "granted") {
          try {
            Notification.requestPermission();
          } catch (e) {}
        }

        poll();
        setInterval(poll, 6000);
      })();
    </script>
  </body>
</html>
